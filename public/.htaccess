# Music Locker - Apache Configuration
# Handles URL rewriting and static asset serving

# Enable URL rewriting
RewriteEngine On

# Security: Block access to sensitive files and directories
RewriteRule ^(.*/)?\.git/ - [F,L]
RewriteRule ^(.*/)?\.env$ - [F,L]
RewriteRule ^(.*/)?composer\.(json|lock)$ - [F,L]

# Serve static assets directly (CSS, JS, Images, Fonts)
RewriteCond %{REQUEST_FILENAME} -f
RewriteCond %{REQUEST_URI} \.(css|js|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot|map)$ [NC]
RewriteRule . - [L]

# Allow direct access to existing files and directories
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Route all other requests through index.php (Front Controller Pattern)
RewriteRule ^(.*)$ index.php [QSA,L]

# Security Headers
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always append X-Frame-Options SAMEORIGIN
    
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options nosniff
    
    # Enable XSS protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Cache static assets for better performance
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=2592000"
        Header set Expires "Thu, 31 Dec 2025 23:59:59 GMT"
    </FilesMatch>
</IfModule>

# Directory browsing prevention
Options -Indexes

# File upload size limits (adjust as needed)
php_value upload_max_filesize 10M
php_value post_max_size 10M

# PHP error handling for production
# Uncomment these lines when deploying to production
# php_flag display_errors Off
# php_flag log_errors On
# php_value error_log ../storage/logs/php-errors.log

# Compress text files for better performance
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# Force HTTPS in production (uncomment when deploying)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]